<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-[#162013] dark group/design-root overflow-x-hidden"
      style="--checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(22,32,19)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e'); font-family: Manrope, &quot;Noto Sans&quot;, sans-serif;"
    >
      <div class="layout-container flex h-full grow flex-col">
        <div id="header"></div>
        <script>
          fetch('header.html')
            .then(response => response.text())
            .then(data => document.getElementById('header').innerHTML = data);
        </script>
        
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <p class="text-white tracking-light text-[32px] font-bold leading-tight min-w-72">Daily Missions</p>
              <button
                id="create-mission-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#2e4328] text-white text-sm font-medium leading-normal"
              >
                <span class="truncate">Create Mission</span>
              </button>
            </div>

            <!-- 任務列表容器 -->
            <div id="missions-list">
              <!-- 現有的靜態任務項目，之後會被動態內容替換 -->
              <div class="flex items-center gap-4 bg-[#162013] px-4 min-h-[72px] py-2 justify-between">
                <div class="flex flex-col justify-center">
                  <p class="text-white text-base font-medium leading-normal line-clamp-1">Complete 5000 steps</p>
                  <p class="text-[#a1c398] text-sm font-normal leading-normal line-clamp-2">Easy</p>
                </div>
                <div class="shrink-0">
                  <div class="flex size-7 items-center justify-center">
                    <input
                      type="checkbox"
                      class="h-5 w-5 rounded border-[#416039] border-2 bg-transparent text-[#50d22c] checked:bg-[#50d22c] checked:border-[#50d22c] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#416039] focus:outline-none"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 創建任務表單 Modal -->
        <div id="create-mission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
          <div class="bg-[#162013] rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-white text-xl font-bold mb-4">Create New Mission</h3>
            <form id="create-mission-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Category</label>
                  <input
                    type="text"
                    name="MCATEGORY"
                    required
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="e.g., Exercise, Study, Health"
                  />
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Description</label>
                  <textarea
                    name="MDESCRIPTION"
                    required
                    rows="3"
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="Describe your mission..."
                  ></textarea>
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Difficulty</label>
                  <select
                    name="MDIFFICULT"
                    required
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                  >
                    <option value="">Select difficulty</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                  </select>
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Goal EXP</label>
                  <input
                    type="number"
                    name="MGOAL_EXP"
                    required
                    min="1"
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="Experience points to gain"
                  />
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Goal Level</label>
                  <input
                    type="number"
                    name="MGOAL_LEVEL"
                    required
                    min="1"
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="Target level"
                  />
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button
                  type="button"
                  id="cancel-btn"
                  class="flex-1 py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="flex-1 py-2 px-4 bg-[#50d22c] text-black rounded hover:bg-[#45b827] font-medium"
                >
                  Create Mission
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM 元素
      const createMissionBtn = document.getElementById('create-mission-btn');
      const createMissionModal = document.getElementById('create-mission-modal');
      const createMissionForm = document.getElementById('create-mission-form');
      const cancelBtn = document.getElementById('cancel-btn');
      const missionsListContainer = document.getElementById('missions-list');

      // 顯示創建任務 Modal
      createMissionBtn.addEventListener('click', () => {
        createMissionModal.style.display = 'flex';
      });

      // 隱藏 Modal
      cancelBtn.addEventListener('click', () => {
        createMissionModal.style.display = 'none';
        createMissionForm.reset();
      });

      // 點擊背景關閉 Modal
      createMissionModal.addEventListener('click', (e) => {
        if (e.target === createMissionModal) {
          createMissionModal.style.display = 'none';
          createMissionForm.reset();
        }
      });

      // 提交表單
      createMissionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(createMissionForm);
        
        fetch('add_mission.php', {
          method: 'POST',
          body: formData
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(result => {
          if (result.success) {
            alert('任務創建成功！');
            createMissionModal.style.display = 'none';
            createMissionForm.reset();
            loadMissions(); // 重新載入任務列表
          } else {
            alert('創建失敗: ' + (result.error || '未知錯誤'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('發生錯誤，請稍後再試');
        });
      });

      // 載入任務列表
      function loadMissions() {
        fetch('get_missions.php')
          .then(res => {
            if (!res.ok) {
              throw new Error('Network response was not ok');
            }
            return res.json();
          })
          .then(missions => {
            missionsListContainer.innerHTML = '';
            if (missions && missions.length > 0) {
              missions.forEach(mission => {
                const missionDiv = document.createElement('div');
                missionDiv.className = "flex items-center gap-4 bg-[#162013] px-4 min-h-[72px] py-2 justify-between";
                missionDiv.innerHTML = `
                  <div class="flex flex-col justify-center">
                    <p class="text-white text-base font-medium leading-normal line-clamp-1">${mission.MCATEGORY}</p>
                    <p class="text-[#a1c398] text-sm font-normal leading-normal line-clamp-2">${mission.MDIFFICULT}</p>
                    <p class="text-[#8a9c87] text-xs font-normal leading-normal">${mission.MDESCRIPTION}</p>
                  </div>
                  <div class="shrink-0">
                    <div class="flex size-7 items-center justify-center">
                      <input
                        type="checkbox"
                        class="h-5 w-5 rounded border-[#416039] border-2 bg-transparent text-[#50d22c] checked:bg-[#50d22c] checked:border-[#50d22c] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#416039] focus:outline-none"
                      />
                    </div>
                  </div>
                `;
                missionsListContainer.appendChild(missionDiv);
              });
            } else {
              missionsListContainer.innerHTML = '<p class="text-white text-center py-8">尚無任務，請創建新任務</p>';
            }
          })
          .catch(error => {
            console.error('Error loading missions:', error);
          });
      }

      // 頁面載入時載入任務
      document.addEventListener('DOMContentLoaded', loadMissions);
    </script>
  </body>
</html>
