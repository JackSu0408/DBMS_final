<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Life is an RPG</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-[#162013] dark group/design-root overflow-x-hidden"
      style="--checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(22,32,19)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e'); font-family: Manrope, &quot;Noto Sans&quot;, sans-serif;"
    >
      <div class="layout-container flex h-full grow flex-col">
        <div id="header"></div>
        <script>
          fetch('header.html')
            .then(response => response.text())
            .then(data => document.getElementById('header').innerHTML = data);
        </script>
        
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <p class="text-white tracking-light text-[32px] font-bold leading-tight min-w-72">Daily Missions</p>
              <button
                id="create-mission-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#2e4328] text-white text-sm font-medium leading-normal"
              >
                <span class="truncate">Create Mission</span>
              </button>
            </div>

            <!-- ä»»å‹™åˆ—è¡¨å®¹å™¨ -->
            <div id="missions-list">
              <!-- ç¾æœ‰çš„éœæ…‹ä»»å‹™é …ç›®ï¼Œä¹‹å¾Œæœƒè¢«å‹•æ…‹å…§å®¹æ›¿æ› -->
              <div class="flex items-center gap-4 bg-[#162013] px-4 min-h-[72px] py-2 justify-between">
                <div class="flex flex-col justify-center">
                  <p class="text-white text-base font-medium leading-normal line-clamp-1">Complete 5000 steps</p>
                  <p class="text-[#a1c398] text-sm font-normal leading-normal line-clamp-2">Easy</p>
                </div>
                <div class="shrink-0">
                  <div class="flex size-7 items-center justify-center">
                    <input
                      type="checkbox"
                      class="h-5 w-5 rounded border-[#416039] border-2 bg-transparent text-[#50d22c] checked:bg-[#50d22c] checked:border-[#50d22c] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#416039] focus:outline-none"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å‰µå»ºä»»å‹™è¡¨å–® Modal -->
        <div id="create-mission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
          <div class="bg-[#162013] rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-white text-xl font-bold mb-4">Create New Mission</h3>
            <form id="create-mission-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Category</label>
                  <input
                    type="text"
                    name="MCATEGORY"
                    required
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="e.g., Exercise, Study, Health"
                  />
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Description</label>
                  <textarea
                    name="MDESCRIPTION"
                    required
                    rows="3"
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                    placeholder="Describe your mission..."
                  ></textarea>
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Difficulty</label>
                  <select
                    name="MDIFFICULT"
                    id="difficulty-select"
                    required
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none"
                  >
                    <option value="">Select difficulty</option>
                    <option value="Easy" data-exp="5">Easy</option>
                    <option value="Medium" data-exp="10">Medium</option>
                    <option value="Hard" data-exp="20">Hard</option>
                  </select>
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-2">Goal EXP</label>
                  <input
                    type="number"
                    name="MGOAL_EXP"
                    id="goal-exp-input"
                    required
                    min="1"
                    readonly
                    class="w-full px-3 py-2 bg-[#2e4328] text-white rounded border border-[#416039] focus:border-[#50d22c] focus:outline-none opacity-75"
                    placeholder="Will be set automatically"
                  />
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button
                  type="button"
                  id="cancel-btn"
                  class="flex-1 py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="flex-1 py-2 px-4 bg-[#50d22c] text-black rounded hover:bg-[#45b827] font-medium"
                >
                  Create Mission
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM å…ƒç´ 
      const createMissionBtn = document.getElementById('create-mission-btn');
      const createMissionModal = document.getElementById('create-mission-modal');
      const createMissionForm = document.getElementById('create-mission-form');
      const cancelBtn = document.getElementById('cancel-btn');
      const missionsListContainer = document.getElementById('missions-list');
      const difficultySelect = document.getElementById('difficulty-select');
      const goalExpInput = document.getElementById('goal-exp-input');

      // é›£åº¦èˆ‡ç¶“é©—å€¼ç¶å®š
      difficultySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const expValue = selectedOption.getAttribute('data-exp');
        
        if (expValue) {
          goalExpInput.value = expValue;
        } else {
          goalExpInput.value = '';
        }
      });

      // é¡¯ç¤ºå‰µå»ºä»»å‹™ Modal
      createMissionBtn.addEventListener('click', () => {
        createMissionModal.style.display = 'flex';
      });

      // éš±è— Modal
      cancelBtn.addEventListener('click', () => {
        createMissionModal.style.display = 'none';
        createMissionForm.reset();
        goalExpInput.value = '';
      });

      // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
      createMissionModal.addEventListener('click', (e) => {
        if (e.target === createMissionModal) {
          createMissionModal.style.display = 'none';
          createMissionForm.reset();
          goalExpInput.value = '';
        }
      });

      // æäº¤è¡¨å–®
      createMissionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(createMissionForm);
        
        fetch('add_mission.php', {
          method: 'POST',
          body: formData
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(result => {
          if (result.success) {
            alert('ä»»å‹™å‰µå»ºæˆåŠŸï¼');
            createMissionModal.style.display = 'none';
            createMissionForm.reset();
            goalExpInput.value = '';
            loadMissions();
          } else {
            alert('å‰µå»ºå¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        });
      });

      // è¼‰å…¥ä»»å‹™åˆ—è¡¨
      function loadMissions() {
        fetch('get_missions.php')
          .then(res => {
            if (!res.ok) {
              throw new Error('Network response was not ok');
            }
            return res.json();
          })
          .then(missions => {
            missionsListContainer.innerHTML = '';
            if (missions && missions.length > 0) {
              missions.forEach(mission => {
                const isCompleted = mission.is_completed == 1;
                const missionDiv = document.createElement('div');
                
                // æ ¹æ“šå®Œæˆç‹€æ…‹è¨­å®šä¸åŒçš„æ¨£å¼
                missionDiv.className = `flex items-center gap-4 bg-[#162013] px-4 min-h-[72px] py-2 justify-between ${isCompleted ? 'opacity-60' : ''}`;
                
                missionDiv.innerHTML = `
                  <div class="flex flex-col justify-center">
                    <p class="text-white text-base font-medium leading-normal line-clamp-1 ${isCompleted ? 'line-through text-gray-400' : ''}">${mission.MCATEGORY}</p>
                    <p class="text-[#a1c398] text-sm font-normal leading-normal line-clamp-2 ${isCompleted ? 'line-through text-gray-500' : ''}">${mission.MDIFFICULT} (${mission.MGOAL_EXP} EXP)</p>
                    <p class="text-[#8a9c87] text-xs font-normal leading-normal ${isCompleted ? 'line-through text-gray-600' : ''}">${mission.MDESCRIPTION}</p>
                    ${isCompleted ? '<p class="text-[#50d22c] text-xs font-semibold mt-1">âœ“ å·²å®Œæˆ</p>' : ''}
                  </div>
                  <div class="shrink-0">
                    <div class="flex size-7 items-center justify-center">
                      <input
                        type="checkbox"
                        data-mission-id="${mission.MID}"
                        data-mission-exp="${mission.MGOAL_EXP}"
                        data-mission-name="${mission.MCATEGORY}"
                        ${isCompleted ? 'checked disabled' : ''}
                        class="mission-checkbox h-5 w-5 rounded border-[#416039] border-2 bg-transparent text-[#50d22c] checked:bg-[#50d22c] checked:border-[#50d22c] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#416039] focus:outline-none ${isCompleted ? 'cursor-not-allowed' : ''}"
                      />
                    </div>
                  </div>
                `;
                missionsListContainer.appendChild(missionDiv);
              });

              // ç‚ºæ‰€æœ‰æœªå®Œæˆçš„ä»»å‹™æ‰“å‹¾æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
              const checkboxes = document.querySelectorAll('.mission-checkbox:not([disabled])');
              checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleMissionComplete);
              });
            } else {
              missionsListContainer.innerHTML = '<p class="text-white text-center py-8">å°šç„¡ä»»å‹™ï¼Œè«‹å‰µå»ºæ–°ä»»å‹™</p>';
            }
          })
          .catch(error => {
            console.error('Error loading missions:', error);
          });
      }

      // è™•ç†ä»»å‹™å®Œæˆ
      function handleMissionComplete(event) {
        const checkbox = event.target;
        const missionId = checkbox.getAttribute('data-mission-id');
        const missionExp = checkbox.getAttribute('data-mission-exp');
        const missionName = checkbox.getAttribute('data-mission-name');

        if (checkbox.checked) {
          // ç¢ºèªå°è©±æ¡†
          if (confirm(`ç¢ºå®šè¦å®Œæˆä»»å‹™ã€Œ${missionName}ã€å—ï¼Ÿ\næ‚¨å°‡ç²å¾— ${missionExp} ç¶“é©—å€¼ã€‚`)) {
            completeMission(missionId, missionExp, missionName, checkbox);
          } else {
            // å–æ¶ˆå‹¾é¸
            checkbox.checked = false;
          }
        }
      }

      // å®Œæˆä»»å‹™ä¸¦æ›´æ–°ç¶“é©—å€¼
      function completeMission(missionId, exp, missionName, checkbox) {
        // ç¦ç”¨å¾©é¸æ¡†é˜²æ­¢é‡è¤‡é»æ“Š
        checkbox.disabled = true;
        
        fetch('complete_mission.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            mission_id: missionId,
            exp_gained: parseInt(exp)
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // æª¢æŸ¥æ˜¯å¦æœ‰å‡ç´š
            if (data.level_up) {
              // é¡¯ç¤ºå‡ç´šæ…¶ç¥å‹•ç•«
              showLevelUpCelebration(
                data.old_level, 
                data.new_level, 
                data.new_title, 
                data.exp_gained, 
                missionName,
                data.current_exp,
                data.new_exp
              );
            } else {
              // æ™®é€šå®Œæˆä»»å‹™æç¤º
              showMissionCompleteNotification(missionName, data.exp_gained, data.new_exp);
            }
            
            // é‡æ–°è¼‰å…¥ä»»å‹™åˆ—è¡¨ä»¥æ›´æ–°é¡¯ç¤ºç‹€æ…‹
            loadMissions();
          } else {
            alert('å®Œæˆä»»å‹™å¤±æ•—: ' + data.error);
            checkbox.checked = false;
            checkbox.disabled = false;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
          checkbox.checked = false;
          checkbox.disabled = false;
        });
      }

      // é¡¯ç¤ºä»»å‹™å®Œæˆé€šçŸ¥ï¼ˆç„¡å‡ç´šï¼‰
      function showMissionCompleteNotification(missionName, expGained, newTotalExp) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-[#2e4328] to-[#416039] text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
        notification.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-xl">âœ…</div>
            <div>
              <h3 class="font-bold">ä»»å‹™å®Œæˆï¼</h3>
              <p class="text-sm">${missionName}</p>
              <p class="text-[#53d22c] text-sm font-semibold">+${expGained} EXP</p>
              <p class="text-[#a1c398] text-xs">ç¸½ç¶“é©—å€¼: ${newTotalExp}</p>
            </div>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªå‹•ç§»é™¤
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // é¡¯ç¤ºå‡ç´šæ…¶ç¥å‹•ç•«
      function showLevelUpCelebration(oldLevel, newLevel, newTitle, expGained, missionName, oldExp, newExp) {
        // å‰µå»ºå…¨å±è¦†è“‹å±¤
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100]';
        
        // å‰µå»ºæ…¶ç¥å…§å®¹
        const celebrationContent = document.createElement('div');
        celebrationContent.className = 'text-center transform scale-0 transition-all duration-500';
        celebrationContent.innerHTML = `
          <div class="mb-8">
            <!-- å‡ç´šç‰¹æ•ˆ -->
            <div class="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-600 mb-4 animate-pulse">
              LEVEL UP!
            </div>
            
            <!-- ç­‰ç´šè®ŠåŒ– -->
            <div class="flex items-center justify-center gap-6 mb-6">
              <div class="text-center">
                <div class="text-xl font-bold text-gray-300 mb-2">èˆŠç­‰ç´š</div>
                <div class="text-4xl font-bold text-[#a2c398] bg-[#2e4328] rounded-full w-20 h-20 flex items-center justify-center mx-auto border-2 border-[#416039]">
                  ${oldLevel}
                </div>
              </div>
              
              <div class="text-4xl text-[#53d22c] animate-pulse">âœ</div>
              
              <div class="text-center">
                <div class="text-xl font-bold text-yellow-300 mb-2">æ–°ç­‰ç´š</div>
                <div class="text-4xl font-bold text-yellow-900 bg-gradient-to-r from-yellow-400 to-yellow-200 rounded-full w-20 h-20 flex items-center justify-center mx-auto shadow-lg shadow-yellow-500/50 border-2 border-yellow-400 animate-pulse">
                  ${newLevel}
                </div>
              </div>
            </div>
            
            <!-- ç¶“é©—å€¼è®ŠåŒ– -->
            <div class="mb-6 bg-[#1a2817] rounded-lg p-4 border border-[#416039]">
              <div class="text-lg font-semibold text-[#53d22c] mb-2">ç¶“é©—å€¼è®ŠåŒ–</div>
              <div class="flex items-center justify-center gap-2 text-white">
                <span>${oldExp} EXP</span>
                <span class="text-[#53d22c]">+${expGained}</span>
                <span class="text-[#53d22c]">â†’</span>
                <span class="text-yellow-300 font-bold">${newExp} EXP</span>
              </div>
            </div>
            
            <!-- ä»»å‹™å®Œæˆè³‡è¨Š -->
            <div class="text-white/90 mb-8 bg-[#162013] rounded-lg p-4 border border-[#2e4328]">
              <div class="text-lg mb-2">âœ… å®Œæˆä»»å‹™</div>
              <div class="text-xl font-semibold text-[#53d22c] mb-1">${missionName}</div>
              <div class="text-lg text-yellow-300">ğŸŒŸ ç²å¾— ${expGained} ç¶“é©—å€¼</div>
            </div>
            
            <!-- é—œé–‰æŒ‰éˆ• -->
            <button class="bg-gradient-to-r from-[#53d22c] to-[#8cd279] text-[#0f1a0d] px-8 py-4 rounded-full font-bold text-lg hover:shadow-lg hover:shadow-[#53d22c]/50 transition-all duration-300 transform hover:scale-105 border-2 border-[#53d22c]">
              ğŸ‰ å¤ªæ£’äº†ï¼ç¹¼çºŒåŠ æ²¹ï¼ ğŸ‰
            </button>
          </div>
        `;
        
        overlay.appendChild(celebrationContent);
        document.body.appendChild(overlay);
        
        // æ·»åŠ ç²’å­ç‰¹æ•ˆ
        createParticleEffect(overlay);
        
        // æ’­æ”¾å‡ç´šéŸ³æ•ˆï¼ˆå¯é¸ï¼‰
        playLevelUpSound();
        
        // è§¸ç™¼å‹•ç•«
        setTimeout(() => {
          celebrationContent.style.transform = 'scale(1)';
        }, 100);
        
        // é»æ“Šé—œé–‰
        const closeButton = celebrationContent.querySelector('button');
        closeButton.addEventListener('click', () => {
          celebrationContent.style.transform = 'scale(0)';
          overlay.style.opacity = '0';
          setTimeout(() => {
            if (document.body.contains(overlay)) {
              document.body.removeChild(overlay);
            }
          }, 500);
        });
        
        // 12ç§’å¾Œè‡ªå‹•é—œé–‰
        setTimeout(() => {
          if (document.body.contains(overlay)) {
            closeButton.click();
          }
        }, 12000);
      }

      // æ’­æ”¾å‡ç´šéŸ³æ•ˆï¼ˆå¯é¸åŠŸèƒ½ï¼‰
      function playLevelUpSound() {
        // å¦‚æœæœ‰éŸ³æ•ˆæ–‡ä»¶ï¼Œå¯ä»¥åœ¨é€™è£¡æ’­æ”¾
        // const audio = new Audio('sounds/levelup.mp3');
        // audio.play().catch(e => console.log('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ:', e));
      }

      // å‰µå»ºç²’å­ç‰¹æ•ˆ
      function createParticleEffect(container) {
        const particles = [];
        const particleCount = 60;
        const colors = ['#fbbf24', '#f59e0b', '#d97706', '#53d22c', '#8cd279'];
        
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          const color = colors[Math.floor(Math.random() * colors.length)];
          const size = Math.random() * 6 + 2;
          
          particle.className = 'absolute rounded-full opacity-80';
          particle.style.width = size + 'px';
          particle.style.height = size + 'px';
          particle.style.backgroundColor = color;
          particle.style.left = Math.random() * window.innerWidth + 'px';
          particle.style.top = Math.random() * window.innerHeight + 'px';
          particle.style.animation = `particle-float ${3 + Math.random() * 4}s infinite linear`;
          particle.style.boxShadow = `0 0 ${size}px ${color}`;
          
          container.appendChild(particle);
          particles.push(particle);
        }
        
        // æ·»åŠ ç²’å­å‹•ç•«CSS
        if (!document.getElementById('particle-styles')) {
          const style = document.createElement('style');
          style.id = 'particle-styles';
          style.textContent = `
            @keyframes particle-float {
              0% { 
                transform: translateY(0px) rotate(0deg) scale(0); 
                opacity: 0; 
              }
              10% {
                opacity: 1;
                transform: translateY(-10px) rotate(36deg) scale(1);
              }
              90% {
                opacity: 1;
                transform: translateY(-90vh) rotate(324deg) scale(1);
              }
              100% { 
                transform: translateY(-100vh) rotate(360deg) scale(0); 
                opacity: 0; 
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        // 8ç§’å¾Œæ¸…ç†ç²’å­
        setTimeout(() => {
          particles.forEach(particle => {
            if (container.contains(particle)) {
              container.removeChild(particle);
            }
          });
        }, 8000);
      }

      // é é¢è¼‰å…¥æ™‚è¼‰å…¥ä»»å‹™
      document.addEventListener('DOMContentLoaded', loadMissions);
    </script>
  </body>
</html>
